<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa interactivo ‚Äì Fichas multimedia</title>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <style>
    :root{
      --bg:#0b0f14; --panel:#121822; --muted:#95a3b3; --text:#e8edf2; --accent:#52b788; --accent-2:#00c2ff;
      --card:#0f141b; --shadow:0 10px 30px rgba(0,0,0,.3);
    }
    *{box-sizing:border-box}
    html,body,#app{height:100%;margin:0}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(120deg,#0b0f14,#111826);color:var(--text)}
    #app{display:grid;grid-template-rows:auto 1fr}
    .topbar{display:flex;gap:.75rem;align-items:center;padding:.75rem 1rem;border-bottom:1px solid rgba(255,255,255,.06);backdrop-filter:blur(6px);position:sticky;top:0;z-index:1000}
    .brand{display:flex;align-items:center;gap:.5rem;font-weight:700;letter-spacing:.3px}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(45deg,var(--accent),var(--accent-2));box-shadow:0 0 14px var(--accent-2)}
    .topbar .actions{display:flex;gap:.5rem;margin-left:auto}
    .btn{display:inline-flex;align-items:center;gap:.5rem;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.04);color:var(--text);padding:.55rem .8rem;border-radius:12px;cursor:pointer;transition:.2s;backdrop-filter:blur(2px)}
    .btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.2)}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#001018;border:none}
    #map{height:100%;width:100%}
    .overlay{position:absolute;right:1rem;top:5.5rem;display:flex;flex-direction:column;gap:.6rem;z-index:999}
    .chip{padding:.45rem .7rem;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);font-size:.85rem}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:1rem;z-index:2000}
    .modal.open{display:flex}
    .card{width:min(900px,96vw);background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:20px;box-shadow:var(--shadow);overflow:hidden}
    .card header{display:flex;justify-content:space-between;align-items:center;padding:1rem;border-bottom:1px solid rgba(255,255,255,.06)}
    .card h3{margin:.2rem 0;font-size:1.25rem}
    .tags{display:flex;flex-wrap:wrap;gap:.4rem}
    .tag{font-size:.75rem;background:rgba(82,183,136,.15);border:1px solid rgba(82,183,136,.4);color:#bff3d6;padding:.25rem .5rem;border-radius:999px}
    .content{display:grid;gap:1rem;padding:1rem}
    @media(min-width:900px){.content{grid-template-columns:1.4fr 1fr}}
    .gallery img, .gallery video, .gallery iframe{width:100%;height:360px;object-fit:cover;background:#0a0f14;border-radius:8px}
    .details{display:flex;flex-direction:column;gap:.75rem}
    .details p{color:var(--muted);line-height:1.6;margin:0}
    .close{cursor:pointer;border:none;background:transparent;color:var(--muted);font-size:1.2rem}
    .form-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:3000}
    .form-modal.open{display:flex}
    .form-box{background:#1b232d;padding:1.5rem;border-radius:12px;width:420px;max-height:90%;overflow:auto}
    .form-box label{display:block;margin:.5rem 0 .2rem}
    .form-box input, .form-box textarea{width:100%;padding:.5rem;border-radius:8px;border:none;margin-bottom:.5rem;background:#0f141b;color:#fff}
    .form-box button{margin-top:.5rem}
    /* small responsive tweaks */
    @media(max-width:560px){ .form-box{width:94vw} .brand{font-size:0.95rem} }
  </style>
</head>
<body>
  <div id="app">
    <div class="topbar">
      <div class="brand"><span class="dot"></span>Mapa interactivo</div>
      <div class="actions">
        <button id="locate" class="btn">üìç Ubicarme</button>
        <button id="reset" class="btn">üîé Reset</button>
      </div>
    </div>
    <div style="position:relative">
      <div id="map"></div>
      <div class="overlay">
        <div class="chip">Click en el mapa para agregar un punto</div>
        <div class="chip" id="count">0 elementos</div>
      </div>
    </div>
  </div>

  <!-- Modal de detalles -->
  <div class="modal" id="modal">
    <div class="card">
      <header>
        <div><h3 id="m-title"></h3><div class="tags" id="m-tags"></div></div>
        <div>
          <button id="editBtn" class="btn">‚úé Editar</button>
          <button id="deleteBtn" class="btn">üóë Eliminar</button>
          <button class="close" id="m-close">‚úï</button>
        </div>
      </header>
      <div class="content">
        <div class="details">
          <p id="m-desc"></p>
          <audio id="m-audio" controls></audio>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de formulario -->
  <div class="form-modal" id="formModal">
    <div class="form-box">
      <h3 id="formTitle">Nuevo punto</h3>
      <form id="pointForm" enctype="multipart/form-data">
        <label>T√≠tulo</label>
        <input type="text" id="f-title" name="title" required>
        <label>Descripci√≥n</label>
        <textarea id="f-desc" name="description"></textarea>
        <label>Tags (separados por coma)</label>
        <input type="text" id="f-tags" name="tags">

        <label>Im√°genes</label>
        <input type="file" id="f-images" name="images" accept="image/*" multiple>
        <label>Audio</label>
        <input type="file" id="f-audio" name="audio" accept="audio/*">
        <label>Video</label>
        <input type="file" id="f-video" name="video" accept="video/*">

        <input type="hidden" id="f-lat" name="lat">
        <input type="hidden" id="f-lng" name="lng">
        <input type="hidden" id="f-id" name="id">

        <button type="submit" class="btn primary">Guardar</button>
        <button type="button" class="btn" id="cancelForm">Cancelar</button>
      </form>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    /* -------------------------
       Config y utilitarios
       ------------------------- */
    let places = [];
    const MAP_CENTER = [4.7110, -74.0721];
    const map = L.map('map').setView(MAP_CENTER, 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
    const cluster = L.markerClusterGroup();
    map.addLayer(cluster);
    const icon = L.divIcon({html:'<div style="width:18px;height:18px;border-radius:50%;background:linear-gradient(135deg,#52b788,#00c2ff);"></div>',className:'',iconSize:[18,18]});
    const markersIndex = new Map();

    // b√∫squeda (inserta input en topbar)
    const topbar = document.querySelector('.topbar');
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.placeholder = 'Buscar lugar...';
    searchInput.style.cssText = `
      padding:.4rem .6rem;border-radius:8px;border:none;width:200px;
      background:rgba(255,255,255,.9);color:#000;font-size:0.9rem;margin-right:0.5rem;
    `;
    topbar.insertBefore(searchInput, topbar.firstChild);
    searchInput.addEventListener('input', () => {
      const query = searchInput.value.toLowerCase().trim();
      cluster.clearLayers();
      places.forEach(p => {
        if (!query || p.title?.toLowerCase().includes(query) || (p.tags||[]).some(t=>t.toLowerCase().includes(query))) {
          const m = markersIndex.get(p.id);
          if (m) cluster.addLayer(m);
        }
      });
    });

    // preview tooltip
    const previewDiv = document.createElement('div');
    previewDiv.style.cssText = `
      position:absolute;pointer-events:none;background:rgba(0,0,0,.78);
      color:#fff;padding:.5rem 1rem;border-radius:8px;max-width:260px;
      display:none;z-index:2000;font-size:0.9rem;
    `;
    document.body.appendChild(previewDiv);

    /* -------------------------
       Carga/Render markers
       ------------------------- */
    async function loadPlaces() {
      try {
        const res = await fetch('/.netlify/functions/places');
        let text = await res.text();
        if (!text || !text.trim()) text = '[]';
        try {
          places = JSON.parse(text);
        } catch {
          console.warn("places.json mal formado, cargando array vac√≠o");
          places = [];
        }
        renderMarkers();
      } catch (err) {
        console.error("Error cargando lugares:", err);
        places = [];
        renderMarkers();
      }
    }

    function renderMarkers(){
      cluster.clearLayers();
      markersIndex.clear();
      places.forEach(p=>{
        // asegurar coords v√°lidos
        const coords = Array.isArray(p.coords) ? p.coords : (p.coords ? JSON.parseSafe?.(p.coords) || (p.lat && p.lng ? [Number(p.lat), Number(p.lng)] : MAP_CENTER) : MAP_CENTER);
        const m = L.marker(coords,{icon});
        m.on('click',()=>openModal(p));
        cluster.addLayer(m);
        markersIndex.set(p.id,m);
      });
      document.getElementById('count').textContent = `${places.length} elementos`;
      enableMarkerPreview();
    }

    function enableMarkerPreview() {
      markersIndex.forEach((m,pid) => {
        const p = places.find(pl=>String(pl.id) === String(pid));
        if (!p) return;
        // limpiar eventos previos
        m.off('mouseover mousemove mouseout');

        m.on('mouseover', e => {
          previewDiv.innerHTML = `<strong style="display:block;margin-bottom:6px">${escapeHtml(p.title || '')}</strong>${(p.tags||[]).map(t=>`<span style="background:#52b788;padding:3px 8px;border-radius:999px;margin-right:4px;font-size:0.8rem;color:#001018">${escapeHtml(t)}</span>`).join('')}`;
          const ev = e.originalEvent || {};
          previewDiv.style.left = (ev.pageX || (window.event && window.event.pageX) || 10) + 12 + 'px';
          previewDiv.style.top = (ev.pageY || (window.event && window.event.pageY) || 10) + 12 + 'px';
          previewDiv.style.display = 'block';
        });
        m.on('mousemove', e => {
          const ev = e.originalEvent || {};
          previewDiv.style.left = (ev.pageX || 10) + 12 + 'px';
          previewDiv.style.top = (ev.pageY || 10) + 12 + 'px';
        });
        m.on('mouseout', () => previewDiv.style.display = 'none');
      });
    }

    // helper seguro para parseo (evita exceptions)
    JSON.parseSafe = function(s){
      try { return JSON.parse(s); } catch { return null; }
    };

    function escapeHtml(str=''){
      return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    /* -------------------------
       Botones - Reset / Ubicarme
       ------------------------- */
    document.getElementById('reset').onclick = () => {
      searchInput.value = '';
      renderMarkers();
      map.setView(MAP_CENTER, 12);
    };
    document.getElementById('locate').onclick = () => {
      if (!navigator.geolocation) return alert('Geolocalizaci√≥n no soportada');
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        map.setView([lat, lng], 15);
        L.marker([lat,lng], {icon}).addTo(map).bindPopup('T√∫ est√°s aqu√≠').openPopup();
      }, () => alert('No se pudo obtener tu ubicaci√≥n'));
    };

    /* -------------------------
       Modal / Formulario
       ------------------------- */
    map.on('click',e=>{
      openForm({coords:[e.latlng.lat,e.latlng.lng]});
    });

    const modal=document.getElementById('modal');
    const mTitle=document.getElementById('m-title');
    const mTags=document.getElementById('m-tags');
    const mDesc=document.getElementById('m-desc');
    const mAudio=document.getElementById('m-audio');
    let currentPoint=null;

    function openModal(p){
      currentPoint = p;
      mTitle.textContent = p.title || '';
      mTags.innerHTML = (p.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('');
      mDesc.textContent = p.description || '';

      if (p.media?.audios?.length) {
        mAudio.src = p.media.audios[0];
        mAudio.style.display = 'block';
      } else {
        mAudio.src = '';
        mAudio.style.display = 'none';
      }

      let gallery = document.querySelector('.gallery');
      if (!gallery) {
        gallery = document.createElement('div');
        gallery.className = 'gallery';
        document.querySelector('.content').prepend(gallery);
      }
      gallery.innerHTML = '';

      if (p.media?.images?.length) {
        p.media.images.forEach(img => {
          const el = document.createElement('img');
          el.src = img;
          gallery.appendChild(el);
        });
      }

      if (p.media?.videos?.length) {
        p.media.videos.forEach(src => {
          const el = document.createElement('video');
          el.src = src;
          el.controls = true;
          gallery.appendChild(el);
        });
      }

      modal.classList.add('open');
    }

    document.getElementById('m-close').onclick=()=>modal.classList.remove('open');
    document.getElementById('editBtn').onclick=()=>{ modal.classList.remove('open'); openForm(currentPoint); }
    document.getElementById('deleteBtn').onclick=async()=>{
      if(!currentPoint) return;
      if(confirm('¬øEliminar este punto?')){
        await fetch('/.netlify/functions/places', {
          method:'DELETE',
          headers: {'Content-Type':'application/json'},
          body:JSON.stringify({id:currentPoint.id})
        });
        await loadPlaces();
        modal.classList.remove('open');
      }
    };

    const formModal=document.getElementById('formModal');
    const pointForm=document.getElementById('pointForm');

    function openForm(p){
      document.getElementById('formTitle').textContent = p.id ? 'Editar punto' : 'Nuevo punto';
      document.getElementById('f-id').value = p.id || '';
      document.getElementById('f-title').value = p.title || '';
      document.getElementById('f-desc').value = p.description || '';
      document.getElementById('f-tags').value = (p.tags||[]).join(',');
      // coords: si vienen como array, asignar a hidden lat/lng
      if (p.coords && Array.isArray(p.coords)) {
        document.getElementById('f-lat').value = p.coords[0];
        document.getElementById('f-lng').value = p.coords[1];
      } else if (p.coords && typeof p.coords === 'string') {
        const parsed = JSON.parseSafe(p.coords);
        if (Array.isArray(parsed)) {
          document.getElementById('f-lat').value = parsed[0];
          document.getElementById('f-lng').value = parsed[1];
        }
      } else if (p.coords && p.lat && p.lng) {
        document.getElementById('f-lat').value = p.lat;
        document.getElementById('f-lng').value = p.lng;
      } else {
        document.getElementById('f-lat').value = p.coords ? p.coords[0] : (p.coords && p.coords[0]) || '';
        document.getElementById('f-lng').value = p.coords ? p.coords[1] : (p.coords && p.coords[1]) || '';
      }
      formModal.classList.add('open');
    }
    document.getElementById('cancelForm').onclick=()=>formModal.classList.remove('open');

    /* -------------------------
       Env√≠o adaptativo (JSON vs multipart/form-data)
       ------------------------- */
    pointForm.onsubmit = async (e) => {
      e.preventDefault();

      const THRESHOLD = 1024 * 1024; // 1 MB => umbral configurable
      const imageFiles = Array.from(document.getElementById("f-images").files || []);
      const audioFiles = Array.from(document.getElementById("f-audio").files || []);
      const videoFiles = Array.from(document.getElementById("f-video").files || []);
      const files = [...imageFiles, ...audioFiles, ...videoFiles];

      const placeBase = {
        id: document.getElementById("f-id").value || Date.now(),
        title: document.getElementById("f-title").value,
        description: document.getElementById("f-desc").value,
        tags: document.getElementById("f-tags").value.split(",").map(t=>t.trim()).filter(Boolean),
        coords: [
          parseFloat(document.getElementById("f-lat").value) || MAP_CENTER[0],
          parseFloat(document.getElementById("f-lng").value) || MAP_CENTER[1]
        ]
      };

      const hasLarge = files.some(f => f.size > THRESHOLD);

      try {
        let res;
        if (hasLarge) {
          // multipart/form-data: incluimos un campo "payload" con el JSON del lugar
          const formData = new FormData();
          formData.append('payload', JSON.stringify(placeBase));
          // adjuntar archivos reales
          files.forEach(file => formData.append('files', file, file.name));
          res = await fetch('/.netlify/functions/places', { method: 'POST', body: formData });
        } else {
          // peque√±o: convertir a base64 y enviar JSON
          const fileObjs = await Promise.all(files.map(async file => {
            const base64 = await fileToBase64(file);
            return { name: file.name, type: file.type, data: base64.split(',')[1] };
          }));
          const payload = {
            ...placeBase,
            files: fileObjs
          };
          res = await fetch('/.netlify/functions/places', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        }

        if (!res.ok) {
          const txt = await res.text();
          console.error('Error guardando lugar:', txt);
          alert('Error al guardar el lugar. Revisa consola.');
          return;
        }

        // todo OK: refrescar lista
        await loadPlaces();
        formModal.classList.remove('open');
      } catch (err) {
        console.error('Error en submit:', err);
        alert('Error en el env√≠o. Revisa consola.');
      }
    };

    // helper convertir archivo -> dataURL
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = err => reject(err);
        reader.readAsDataURL(file);
      });
    }

    /* -------------------------
       Startup
       ------------------------- */
    loadPlaces();
  </script>
</body>
</html>
