<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa interactivo ‚Äì Fichas multimedia</title>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <style>
    :root{
      --bg:#0b0f14; --panel:#121822; --muted:#95a3b3; --text:#e8edf2; --accent:#52b788; --accent-2:#00c2ff;
      --card:#0f141b; --shadow:0 10px 30px rgba(0,0,0,.3);
    }
    *{box-sizing:border-box}
    html,body,#app{height:100%;margin:0}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(120deg,#0b0f14,#111826);color:var(--text)}
    #app{display:grid;grid-template-rows:auto 1fr}
    .topbar{display:flex;gap:.75rem;align-items:center;padding:.75rem 1rem;border-bottom:1px solid rgba(255,255,255,.06);backdrop-filter:blur(6px);position:sticky;top:0;z-index:1000}
    .brand{display:flex;align-items:center;gap:.5rem;font-weight:700;letter-spacing:.3px}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(45deg,var(--accent),var(--accent-2));box-shadow:0 0 14px var(--accent-2)}
    .topbar .actions{display:flex;gap:.5rem;margin-left:auto}
    .btn{display:inline-flex;align-items:center;gap:.5rem;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.04);color:var(--text);padding:.55rem .8rem;border-radius:12px;cursor:pointer;transition:.2s;backdrop-filter:blur(2px)}
    .btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.2)}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#001018;border:none}
    #map{height:100%;width:100%}
    .overlay{position:absolute;right:1rem;top:5.5rem;display:flex;flex-direction:column;gap:.6rem;z-index:999}
    .chip{padding:.45rem .7rem;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);font-size:.85rem}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:1rem;z-index:2000}
    .modal.open{display:flex}
    .card{width:min(900px,96vw);background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:20px;box-shadow:var(--shadow);overflow:hidden}
    .card header{display:flex;justify-content:space-between;align-items:center;padding:1rem;border-bottom:1px solid rgba(255,255,255,.06)}
    .card h3{margin:.2rem 0;font-size:1.25rem}
    .tags{display:flex;flex-wrap:wrap;gap:.4rem}
    .tag{font-size:.75rem;background:rgba(82,183,136,.15);border:1px solid rgba(82,183,136,.4);color:#bff3d6;padding:.25rem .5rem;border-radius:999px}
    .content{display:grid;gap:1rem;padding:1rem}
    @media(min-width:900px){.content{grid-template-columns:1.4fr 1fr}}
    .gallery img, .gallery iframe{width:100%;height:360px;object-fit:cover;background:#0a0f14}
    .details{display:flex;flex-direction:column;gap:.75rem}
    .details p{color:var(--muted);line-height:1.6;margin:0}
    .close{cursor:pointer;border:none;background:transparent;color:var(--muted);font-size:1.2rem}
    .form-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:3000}
    .form-modal.open{display:flex}
    .form-box{background:#1b232d;padding:1.5rem;border-radius:12px;width:400px;max-height:90%;overflow:auto}
    .form-box label{display:block;margin:.5rem 0 .2rem}
    .form-box input, .form-box textarea{width:100%;padding:.5rem;border-radius:8px;border:none;margin-bottom:.5rem;background:#0f141b;color:#fff}
    .form-box button{margin-top:.5rem}
  </style>
</head>
<body>
  <div id="app">
    <div class="topbar">
      <div class="brand"><span class="dot"></span>Mapa interactivo</div>
      <div class="actions">
        <button id="locate" class="btn">üìç Ubicarme</button>
        <button id="reset" class="btn">üîé Reset</button>
      </div>
    </div>
    <div style="position:relative">
      <div id="map"></div>
      <div class="overlay">
        <div class="chip">Click en el mapa para agregar un punto</div>
        <div class="chip" id="count">0 elementos</div>
      </div>
    </div>
  </div>

  <!-- Modal de detalles -->
  <div class="modal" id="modal">
    <div class="card">
      <header>
        <div><h3 id="m-title"></h3><div class="tags" id="m-tags"></div></div>
        <div>
          <button id="editBtn" class="btn">‚úé Editar</button>
          <button id="deleteBtn" class="btn">üóë Eliminar</button>
          <button class="close" id="m-close">‚úï</button>
        </div>
      </header>
      <div class="content">
        <div class="details">
          <p id="m-desc"></p>
          <audio id="m-audio" controls></audio>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de formulario -->
  <div class="form-modal" id="formModal">
    <div class="form-box">
      <h3 id="formTitle">Nuevo punto</h3>
      <form id="pointForm" enctype="multipart/form-data">
        <label>T√≠tulo</label>
        <input type="text" id="f-title" name="title" required>
        <label>Descripci√≥n</label>
        <textarea id="f-desc" name="description"></textarea>
        <label>Tags (separados por coma)</label>
        <input type="text" id="f-tags" name="tags">

        <label>Im√°genes</label>
        <input type="file" id="f-images" name="images" accept="image/*" multiple>
        <label>Audio</label>
        <input type="file" id="f-audio" name="audio" accept="audio/*">
        <label>Video</label>
        <input type="file" id="f-video" name="video" accept="video/*">

        <input type="hidden" id="f-lat" name="lat">
        <input type="hidden" id="f-lng" name="lng">
        <input type="hidden" id="f-id" name="id">

        <button type="submit" class="btn primary">Guardar</button>
        <button type="button" class="btn" id="cancelForm">Cancelar</button>
      </form>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    let places = [];
    const map = L.map('map').setView([4.7110, -74.0721], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
    const cluster = L.markerClusterGroup();
    map.addLayer(cluster);
    const icon = L.divIcon({html:'<div style="width:18px;height:18px;border-radius:50%;background:linear-gradient(135deg,#52b788,#00c2ff);"></div>',className:'',iconSize:[18,18]});
    const markersIndex = new Map();

        // --- Barra de b√∫squeda (dentro de la topbar) ---
    const topbar = document.querySelector('.topbar');
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.placeholder = 'Buscar lugar...';
    searchInput.style.cssText = `
      padding:.4rem .6rem;
      border-radius:8px;
      border:none;
      width:200px;
      background:rgba(255,255,255,.9);
      color:#000;
      font-size:0.9rem;
    `;
    topbar.insertBefore(searchInput, topbar.firstChild);

    searchInput.addEventListener('input', () => {
      const query = searchInput.value.toLowerCase();
      cluster.clearLayers();
      places.forEach(p => {
        if (!query || p.title.toLowerCase().includes(query) || (p.tags||[]).some(t=>t.toLowerCase().includes(query))) {
          const m = markersIndex.get(p.id);
          if (m) cluster.addLayer(m);
        }
      });
    });
    // --- Previsualizaci√≥n al pasar el mouse ---
    const previewDiv = document.createElement('div');
    previewDiv.style.cssText = `
      position:absolute;
      pointer-events:none;
      background:rgba(0,0,0,.75);
      color:#fff;
      padding:.5rem 1rem;
      border-radius:8px;
      max-width:250px;
      display:none;
      z-index:2000;
    `;
    document.body.appendChild(previewDiv);



    async function loadPlaces() {
      try {
        const res = await fetch('/.netlify/functions/places');
        let text = await res.text();

        // fallback a '[]' si est√° vac√≠o
        if (!text || !text.trim()) text = '[]';

        try {
          places = JSON.parse(text);
        } catch {
          console.warn("places.json mal formado, cargando array vac√≠o");
          places = [];
        }

        renderMarkers();
      } catch (err) {
        console.error("Error cargando lugares:", err);
        places = [];
        renderMarkers();     
        enableMarkerPreview();
      }
    }

    function renderMarkers(){
  cluster.clearLayers();
  markersIndex.clear();
  places.forEach(p=>{
    const m = L.marker(p.coords,{icon});
    m.on('click',()=>openModal(p));
    cluster.addLayer(m);
    markersIndex.set(p.id,m);
  });
  document.getElementById('count').textContent = `${places.length} elementos`;

  enableMarkerPreview(); // <<-- aqu√≠ se llama despu√©s de crear los markers
}

function enableMarkerPreview() {
  markersIndex.forEach((m,pid) => {
    const p = places.find(pl=>pl.id === pid);
    if (!p) return;

    // limpiar eventos previos
    m.off('mouseover mousemove mouseout');

    m.on('mouseover', e => {
      previewDiv.innerHTML = `<strong>${p.title}</strong><br>${(p.tags||[]).map(t=>`<span style="background:#52b788;padding:2px 6px;border-radius:4px;margin-right:2px;">${t}</span>`).join('')}`;
      previewDiv.style.left = e.originalEvent.pageX + 10 + 'px';
      previewDiv.style.top = e.originalEvent.pageY + 10 + 'px';
      previewDiv.style.display = 'block';
    });

    m.on('mousemove', e => {
      previewDiv.style.left = e.originalEvent.pageX + 10 + 'px';
      previewDiv.style.top = e.originalEvent.pageY + 10 + 'px';
    });

    m.on('mouseout', () => previewDiv.style.display = 'none');
  });
}

/*
places.forEach(p => {
  const m = markersIndex.get(p.id);
  if (!m) return;
  m.on('mouseover', e => {
    previewDiv.innerHTML = `<strong>${p.title}</strong><br>${(p.tags||[]).map(t=>`<span style="background:#52b788;padding:2px 6px;border-radius:4px;margin-right:2px;">${t}</span>`).join('')}`;
    previewDiv.style.left = e.originalEvent.pageX + 10 + 'px';
    previewDiv.style.top = e.originalEvent.pageY + 10 + 'px';
    previewDiv.style.display = 'block';
  });
  m.on('mousemove', e => {
    previewDiv.style.left = e.originalEvent.pageX + 10 + 'px';
    previewDiv.style.top = e.originalEvent.pageY + 10 + 'px';
  });
  m.on('mouseout', () => previewDiv.style.display = 'none');
});
*/
// --- Bot√≥n Reset ---
document.getElementById('reset').onclick = () => {
  searchInput.value = '';
  renderMarkers();
  map.setView([4.7110, -74.0721], 12);
};

// --- Bot√≥n Ubicarme ---
document.getElementById('locate').onclick = () => {
  if (!navigator.geolocation) return alert('Geolocalizaci√≥n no soportada');
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    map.setView([lat, lng], 15);
    L.marker([lat,lng], {icon}).addTo(map).bindPopup('T√∫ est√°s aqu√≠').openPopup();
  }, () => alert('No se pudo obtener tu ubicaci√≥n'));
};


    map.on('click',e=>{
      openForm({coords:[e.latlng.lat,e.latlng.lng]});
    });

    const modal=document.getElementById('modal');
    const mTitle=document.getElementById('m-title');
    const mTags=document.getElementById('m-tags');
    const mDesc=document.getElementById('m-desc');
    const mAudio=document.getElementById('m-audio');
    let currentPoint=null;

    function openModal(p){
    currentPoint = p;
    mTitle.textContent = p.title;
    mTags.innerHTML = (p.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('');
    mDesc.textContent = p.description;

    // Audio
    if (p.media?.audios?.length) {
      mAudio.src = p.media.audios[0]; // si hay varios, solo el primero
      mAudio.style.display = 'block';
    } else {
      mAudio.style.display = 'none';
    }

    // Im√°genes
    let gallery = document.querySelector('.gallery');
    if (!gallery) {
      gallery = document.createElement('div');
      gallery.className = 'gallery';
      document.querySelector('.content').prepend(gallery);
    }
    gallery.innerHTML = '';
    if (p.media?.images?.length) {
      p.media.images.forEach(img => {
        const el = document.createElement('img');
        el.src = img;
        gallery.appendChild(el);
      });
    }

    // Videos
    if (p.media?.videos?.length) {
      p.media.videos.forEach(src => {
        const el = document.createElement('video');
        el.src = src;
        el.controls = true;
        gallery.appendChild(el);
      });
    }

    modal.classList.add('open');
  }


    document.getElementById('m-close').onclick=()=>modal.classList.remove('open');
    document.getElementById('editBtn').onclick=()=>{modal.classList.remove('open');openForm(currentPoint);} 
    document.getElementById('deleteBtn').onclick=async()=>{
      if(confirm('¬øEliminar este punto?')){
        await fetch('/.netlify/functions/places',{method:'DELETE',body:JSON.stringify({id:currentPoint.id})});
        await loadPlaces();
        modal.classList.remove('open');
      }
    };

    const formModal=document.getElementById('formModal');
    const pointForm=document.getElementById('pointForm');
    function openForm(p){
      document.getElementById('formTitle').textContent=p.id?'Editar punto':'Nuevo punto';
      document.getElementById('f-id').value=p.id||'';
      document.getElementById('f-title').value=p.title||'';
      document.getElementById('f-desc').value=p.description||'';
      document.getElementById('f-tags').value=(p.tags||[]).join(',');
      document.getElementById('f-lat').value=p.coords?p.coords[0]:'';
      document.getElementById('f-lng').value=p.coords?p.coords[1]:'';
      formModal.classList.add('open');
    }
    document.getElementById('cancelForm').onclick=()=>formModal.classList.remove('open');

    pointForm.onsubmit = async (e) => {
  e.preventDefault();

  const body = {
    id: document.getElementById("f-id").value || Date.now(),
    title: document.getElementById("f-title").value,
    description: document.getElementById("f-desc").value,
    tags: document.getElementById("f-tags").value.split(",").map(t=>t.trim()),
    coords: [
      parseFloat(document.getElementById("f-lat").value),
      parseFloat(document.getElementById("f-lng").value)
    ],
    files: []
  };

  // procesar im√°genes
  const imgFiles = document.getElementById("f-images").files;
  for (let file of imgFiles) {
    const base64 = await fileToBase64(file);
    body.files.push({ 
      name: file.name, 
      type: file.type, 
      data: base64.split(",")[1] // quitar encabezado "data:..."
    });
  }

  // audio
  const audioFile = document.getElementById("f-audio").files[0];
  if (audioFile) {
    const base64 = await fileToBase64(audioFile);
    body.files.push({ 
      name: audioFile.name, 
      type: audioFile.type, 
      data: base64.split(",")[1]
    });
  }

  // video
  const videoFile = document.getElementById("f-video").files[0];
  if (videoFile) {
    const base64 = await fileToBase64(videoFile);
    body.files.push({ 
      name: videoFile.name, 
      type: videoFile.type, 
      data: base64.split(",")[1]
    });
  }

  await fetch("/.netlify/functions/places", { 
    method: "POST", 
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  await loadPlaces();
  formModal.classList.remove("open");
};

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = (err) => reject(err);
    reader.readAsDataURL(file);
  });
}


    loadPlaces();
  </script>
</body>
</html>
